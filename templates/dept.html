<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ dept_name }} - Portal</title>
    <style>
        /* --- KEEP ALL YOUR EXISTING STYLES AS IS --- */
        :root {
            --teal-primary: #008080;
            --teal-light: #4fb9b9;
            --teal-dark: #006666;
            --gray-light: #f5f5f5;
            --gray-medium: #e0e0e0;
            --gray-dark: #9e9e9e;
            --text-dark: #333333;
            --text-light: #ffffff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f9f9f9; color: var(--text-dark); line-height: 1.6; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: var(--shadow); overflow: hidden; }
        header { background: linear-gradient(135deg, var(--teal-primary), var(--teal-dark)); color: var(--text-light); padding: 25px; text-align: center; }
        h1 { font-size: 28px; margin-bottom: 5px; }
        .dashboard { display: grid; grid-template-columns: 300px 1fr; gap: 20px; padding: 20px; }
        .sidebar { background-color: var(--gray-light); border-radius: 8px; padding: 20px; height: fit-content; }
        .stats { margin-bottom: 25px; }
        .stat-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--gray-medium); }
        .stat-item:last-child { border-bottom: none; }
        .stat-value { font-weight: 600; color: var(--teal-primary); }
        .filters { margin-top: 20px; }
        .filter-group { margin-bottom: 15px; }
        .filter-group label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--teal-dark); }
        .filter-group select, .filter-group input { width: 100%; padding: 8px; border: 1px solid var(--gray-medium); border-radius: 4px; background-color: white; }
        .main-content { padding: 0 10px; }
        .issues-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .search-box { display: flex; width: 300px; }
        .search-box input { flex-grow: 1; padding: 8px 12px; border: 1px solid var(--gray-medium); border-radius: 4px 0 0 4px; border-right: none; }
        .search-box button { background-color: var(--teal-primary); color: white; border: none; border-radius: 0 4px 4px 0; padding: 0 15px; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background-color: white; box-shadow: var(--shadow); border-radius: 8px; overflow: hidden; }
        th { background-color: var(--teal-primary); color: var(--text-light); padding: 15px; text-align: left; font-weight: 600; }
        td { padding: 15px; border-bottom: 1px solid var(--gray-medium); }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: var(--gray-light); }
        .status-select { padding: 8px; border: 1px solid var(--gray-medium); border-radius: 4px; background-color: white; color: var(--text-dark); width: 100%; cursor: pointer; }
        .status-select:focus { outline: none; border-color: var(--teal-light); }
        .issue-img { width: 80px; height: 60px; object-fit: cover; border-radius: 4px; cursor: pointer; transition: transform 0.2s; }
        .issue-img:hover { transform: scale(1.05); }
        .resolved-badge { display: inline-block; padding: 5px 10px; background-color: var(--teal-light); color: white; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .pending-badge { display: inline-block; padding: 5px 10px; background-color: var(--gray-dark); color: white; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .actions { display: flex; gap: 10px; margin-top: 20px; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; transition: background-color 0.2s; }
        .btn-primary { background-color: var(--teal-primary); color: white; }
        .btn-primary:hover { background-color: var(--teal-dark); }
        .btn-secondary { background-color: var(--gray-medium); color: var(--text-dark); }
        .btn-secondary:hover { background-color: var(--gray-dark); color: white; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 4px; background-color: var(--teal-primary); color: white; box-shadow: var(--shadow); opacity: 0; transform: translateY(-20px); transition: opacity 0.3s, transform 0.3s; z-index: 1000; }
        .notification.show { opacity: 1; transform: translateY(0); }
        .image-modal { display: none; position: fixed; z-index: 1000; padding-top: 60px; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); }
        .modal-content { display: block; margin: 0 auto; max-width: 80%; max-height: 80%; }
        .close-modal { position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer; }
        .no-issues { text-align: center; padding: 30px; color: #6c757d; font-style: italic; }
        @media (max-width: 900px) { .dashboard { grid-template-columns: 1fr; } .sidebar { order: 2; } .main-content { order: 1; } }
        @media (max-width: 600px) { .issues-header { flex-direction: column; align-items: flex-start; gap: 10px; } .search-box { width: 100%; } table { display: block; overflow-x: auto; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>{{ dept_name }} Department Portal</h1>
        </header>

        <div class="dashboard">
            <div class="sidebar">
                <div class="stats">
                    <h3>Department Stats</h3>
                    <div class="stat-item">
                        <span>Total Issues:</span>
                        <span class="stat-value">{{ issues|length if issues else 0 }}</span>
                    </div>
                    <div class="stat-item">
                        <span>Resolved:</span>
                        <span class="stat-value">{{ resolved_count if resolved_count else 0 }}</span>
                    </div>
                    <div class="stat-item">
                        <span>Pending:</span>
                        <span class="stat-value">{{ pending_count if pending_count else 0 }}</span>
                    </div>
                </div>

                <div class="filters">
                    <h3>Filter Issues</h3>
                    <div class="filter-group">
                        <label for="status-filter">Status</label>
                        <select id="status-filter">
                            <option value="all">All Issues</option>
                            <option value="pending">Pending Only</option>
                            <option value="resolved">Resolved Only</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div class="issues-header">
                    <h2>Current Issues ({{ issues|length if issues else 0 }})</h2>
                </div>

                {% if issues %}
                <table>
                    <thead>
                        <tr>
                            <th>Dept Issue ID</th>
                            <th>Image</th>
                            <th>Address</th>
                            <th>Status</th>
                            <th>Last Update</th>
                            <th>Update Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for issue in issues %}
                        <tr id="issue-{{ issue[0] }}">
                            <td>{{ issue[0] }}</td>
                            <td>
                                <img
                                    src="{{ url_for('static', filename='uploads/' ~ issue[2]) }}"
                                    class="issue-img"
                                    onclick="openModal(this.src)"
                                    alt="Issue image"
                                >
                            </td>
                            <td>{{ issue[3] }}</td>
                            <td>
                                {% if issue[4] == 'Resolved' %}
                                <span class="resolved-badge">Resolved</span>
                                {% else %}
                                <span class="pending-badge">Pending</span>
                                {% endif %}
                            </td>
                            <td>{{ issue[5] }}</td>
                            <td>
                                <select
                                    class="status-select"
                                    data-original-value="{{ issue[4] }}"
                                    onchange="updateStatus({{ issue[0] }}, this)"
                                >
                                    <option value="">--Select--</option>
                                    <option value="Resolved" {{ 'selected' if issue[4] == 'Resolved' }}>Resolved</option>
                                    <option value="Pending" {{ 'selected' if issue[4] == 'Pending' }}>Pending</option>
                                </select>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="no-issues">
                    <p>No issues found for this department.</p>
                </div>
                {% endif %}

                <div class="actions">
                    <button class="btn btn-secondary" onclick="window.location.href='{{ url_for('departments') }}'">
                        ← Back to Departments
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="image-modal">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script>
        function openModal(src) {
            document.getElementById('modalImage').src = src;
            document.getElementById('imageModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        function closeModal() {
            document.getElementById('imageModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        window.onclick = function(event) {
            const modal = document.getElementById('imageModal');
            if (event.target === modal) closeModal();
        };

        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification show';
            setTimeout(() => notification.style.opacity = '0', 3000);
        }

        async function updateStatus(issueId, selectElem) {
            const status = selectElem.value;
            if (!status) return;

            try {
                const formData = new FormData();
                formData.append('issue_id', issueId);
                formData.append('status', status);

                const response = await fetch(window.location.pathname, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    showNotification('Status updated successfully!');

                    const statusCell = selectElem.closest('tr').querySelector('td:nth-child(4)');
                    if (status === 'Resolved') {
                        statusCell.innerHTML = '<span class="resolved-badge">Resolved</span>';
                        setTimeout(() => {
                            const row = document.getElementById('issue-' + issueId);
                            if (row) { row.style.transition='opacity 0.5s'; row.style.opacity='0';
                                setTimeout(() => { row.remove(); updateStats(); }, 500);
                            }
                        }, 1500);
                    } else {
                        statusCell.innerHTML = '<span class="pending-badge">Pending</span>';
                    }
                } else throw new Error('Failed to update status');
            } catch (error) {
                console.error(error);
                showNotification('Failed to update status. Try again.');
                selectElem.value = selectElem.getAttribute('data-original-value');
            }
        }

        function updateStats() {
            const rows = document.querySelectorAll('tbody tr');
            const totalIssues = rows.length;
            const resolvedCount = document.querySelectorAll('.resolved-badge').length;
            const pendingCount = document.querySelectorAll('.pending-badge').length;

            document.querySelector('.issues-header h2').textContent = `Current Issues (${totalIssues})`;
            const statValues = document.querySelectorAll('.stat-item .stat-value');
            statValues[0].textContent = totalIssues;
            statValues[1].textContent = resolvedCount;
            statValues[2].textContent = pendingCount;

            if (totalIssues === 0) {
                document.querySelector('tbody').innerHTML = '<tr><td colspan="6" style="text-align:center;padding:30px;color:var(--gray-dark);">All issues have been resolved!</td></tr>';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const selects = document.querySelectorAll('.status-select');
            selects.forEach(s => s.setAttribute('data-original-value', s.value));

            document.getElementById('status-filter').addEventListener('change', function() {
                const status = this.value;
                const rows = document.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    if (status === 'all') row.style.display = '';
                    else if (status === 'pending') row.style.display = row.querySelector('.pending-badge') ? '' : 'none';
                    else if (status === 'resolved') row.style.display = row.querySelector('.resolved-badge') ? '' : 'none';
                });
            });
        });
    </script>
</body>
</html>
